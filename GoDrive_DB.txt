create database locadora;

----------------------------------------------------------DDL-----------------------------------------------------------

CREATE TABLE pais (
id int not null PRIMARY KEY AUTO_INCREMENT,
NOME VARCHAR(45) NOT NULL,
SIGLA CHAR(3) NOT NULL
);


CREATE TABLE estado (
ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOME VARCHAR(45) NOT NULL,
SIGLA CHAR(2) NOT NULL
);

ALTER TABLE estado
ADD PAIS_ID INT;

ALTER TABLE estado 
ADD CONSTRAINT FK_PAIS
FOREIGN KEY (PAIS_ID)
REFERENCES pais (id);

CREATE TABLE cidade(
ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
NOME VARCHAR(45) NOT NULL,
ESTADO_ID INT NOT NULL
);

ALTER TABLE cidade 
ADD CONSTRAINT FK_ESTADO
FOREIGN KEY (ESTADO_ID)
REFERENCES estado (ID);

CREATE TABLE tipo_logradouro(
ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
DESCRICAO VARCHAR(45) NOT NULL
);

CREATE TABLE endereco (
ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
LOGRADOURO VARCHAR(45) NOT NULL,
BAIRRO VARCHAR(45) NOT NULL,
NUMERO VARCHAR(10) NOT NULL,
TIPO_LOGRADOURO_ID INT NOT NULL,
CIDADE_ID INT NOT NULL
);


ALTER TABLE endereco 
ADD CONSTRAINT FK_CIDADE
FOREIGN KEY (CIDADE_ID)
REFERENCES cidade (ID),
ADD CONSTRAINT FK_TIPO_LOGRADOURO
FOREIGN KEY (TIPO_LOGRADOURO_ID)
REFERENCES tipo_logradouro (ID)
;


CREATE TABLE cliente_fornecedor(
ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
CPF VARCHAR(11),
CNPJ VARCHAR(14),
NOME VARCHAR(45) NOT NULL,
CLIENTE_FORNECEDOR CHAR(1) NOT NULL,
DATA_NASC DATE,
EMAIL VARCHAR(45),
CNH CHAR(15),
VALIDADE_CNH DATE,
TELEFONE VARCHAR(45),
ENDERECO_ID INT NOT NULL
);


CREATE TABLE PLANO_PGT(
ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
FORMA_PGT CHAR(1) NOT NULL,
PARCELAS INT NOT NULL,
VALOR FLOAT NOT NULL
);


CREATE TABLE transacao(
ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
DT_PG DATE NOT NULL,
VALOR_PAGO FLOAT(5,2) NOT NULL,
STATUS CHAR(1) NOT NULL,
MULTAS FLOAT,
DESCONTOS FLOAT,
PLANO_PGT_ID INT NOT NULL
);

ALTER TABLE transacao 
ADD CONSTRAINT FK_PLANO_PGT
FOREIGN KEY (PLANO_PGT_ID)
REFERENCES plano_pgt (ID);


CREATE TABLE contrato(
ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
DT_CONTRATO DATE NOT NULL,
DT_RETIRADA DATETIME NOT NULL,
DT_PREVISTA DATETIME NOT NULL,
DT_DEVOLUCAO DATETIME NOT NULL,
STATUS CHAR(1) NOT NULL,
TERMO_ACEITE LONGTEXT NOT NULL,
CLIENTE_FORNCEDOR_ID INT NOT NULL,
TRANSACAO_ID INT NOT NULL
);

ALTER TABLE contrato 
ADD CONSTRAINT FK_CLIENTE_FORNECEDOR
FOREIGN KEY (CLIENTE_FORNCEDOR_ID)
REFERENCES cliente_fornecedor (ID),

ADD CONSTRAINT FK_TRANSACAO
FOREIGN KEY (TRANSACAO_ID)
REFERENCES transacao (ID)
;

CREATE TABLE veiculos(
ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
MARCA VARCHAR(45) NOT NULL,
TIPO_VEICULO VARCHAR(45) NOT NULL,
ESPECIE VARCHAR (45) NOT NULL,
PLACA VARCHAR(45) NOT NULL,
COR VARCHAR (45) NOT NULL,
KM INT NOT NULL,
TIPO_COMBUST CHAR(1) NOT NULL,
STATUS CHAR(1) NOT NULL,
DT_AQUISICAO DATE NOT NULL,
CATEGORIA VARCHAR(45) NOT NULL,
MODELO VARCHAR(45) NOT NULL,
CHASSI VARCHAR(45)
);


CREATE TABLE manutencao(
ID INT NOT NULL PRIMARY KEY AUTO_INCREMENT,
TIPO CHAR(1) NOT NULL,
DT_MANUTENCAO DATE NOT NULL,
DESCRICAO_SERV VARCHAR(50) NOT NULL,
CUSTO FLOAT(5,2) NOT NULL,
CLIENTE_FORNCEDOR_ID INT NOT NULL,
VEICULOS_ID INT NOT NULL
);

ALTER TABLE manutencao 
ADD CONSTRAINT FK_CLIENTE_FORNCEDOR
FOREIGN KEY (CLIENTE_FORNCEDOR_ID)
REFERENCES cliente_fornecedor (ID),

ADD CONSTRAINT FK_VEICULOS
FOREIGN KEY (VEICULOS_ID)
REFERENCES veiculos (ID);

CREATE TABLE CONTRATO_VEICULO(
CONTRATO_ID INT NOT NULL,
VEICULO_ID INT NOT NULL,
PRIMARY KEY(CONTRATO_ID, VEICULO_ID)
);


CREATE TABLE contrato_veiculos(
CONTRATO_ID INT NOT NULL,
VEICULOS_ID INT NOT NULL,
PRIMARY KEY (CONTRATO_ID, VEICULOS_ID),
CONSTRAINT FK_CONTRATOS_VEICULOS_CONTRATO
    FOREIGN KEY (CONTRATO_ID)
    REFERENCES contrato (ID),
CONSTRAINT FK_CONTRATOS_VEICULOS_VEICULOS
    FOREIGN KEY (VEICULOS_ID)
    REFERENCES veiculos (ID)
);
    
----------------------------------------------------------DML------------------------------------------------------------

INSERT INTO pais(NOME,SIGLA ) 
VALUES ('BRASIL','BRA');


INSERT INTO pais( NOME, SIGLA) 
VALUES 
('ARGENTEINA', 'ARG'),
('PERU', 'PE');

INSERT INTO estado( NOME, SIGLA, PAIS_ID) 
VALUES 
('PIAUI', 'PI', 1),
('BAHIA', 'BA', 1),
('SÃO PAULO', 'SP', 1);


INSERT INTO cidade(NOME, ESTADO_ID) 
VALUES ('PARNAIBA', 1),
('SÃO PAULO', 3),
('RIBEIRÃO PRETO', 3),
('ILHEUS', 2);

INSERT INTO tipo_logradouro(DESCRICAO) 
VALUES 
('RUA'), 
('AVENIDA');

INSERT INTO endereco(LOGRADOURO, BAIRRO, NUMERO, TIPO_LOGRADOURO_ID, CIDADE_ID) 
VALUES 
('JAMES CLARK', 'SÃO BENEDITO', 1498, 1, 1),
('BRAGA', 'VILA LUZITANIA', 202, 1, 5)


INSERT INTO cliente_fornecedor(CPF,CNPJ, NOME, CLIENTE_FORNECEDOR, DATA_NASC, EMAIL, CNH, VALIDADE_CNH, TELEFONE, ENDERECO_ID) 
VALUES 
('554927031-87', NULL,'MIGUEL SAMORI', 'C', '1973-11-12', 'miguelsanzevedo@gmail.com', '23663697223123', '2024-12-12', '11994094400,', 2 ),
(NULL, '358900000107','OWLINES LTDA', 'C', NULL, 'admin@owlines.com.br', '112233445566789', '2025-06-05', '86999303251', 1);


INSERT INTO plano_pgt(FORMA_PGT, PARCELAS, VALOR) 
VALUES 
('P', 1, 500),
('B', 2, 500),
('C', 5, 500);


INSERT INTO transacao( DT_PG,VALOR_PAGO, STATUS, MULTAS, DESCONTOS, PLANO_PGT_ID) 
VALUES 
('2024-10-10', 500, 'B', NULL, NULL, 2),
('2024-07-22', 0, 'E', NULL, NULL, 3);


INSERT INTO veiculos(MARCA, TIPO_VEICULO, ESPECIE, PLACA, COR, KM, TIPO_COMBUST, STATUS, DT_AQUISICAO, CATEGORIA, MODELO, CHASSI) 
VALUES 
('RENAOUT', 'AUTOMÓVEL', 'PASSAGEIRO', 'EFF6298', 'PRATA', '18000', 'F', 'I', '2020-12-18', 'RET', 'KWID', NULL )

INSERT INTO contrato_veiculos(CONTRATO_ID, VEICULOS_ID) 
VALUES (1,1);

INSERT INTO contrato(DT_CONTRATO, DT_RETIRADA, DT_PREVISTA, DT_DEVOLUCAO, STATUS, TERMO_ACEITE, CLIENTE_FORNCEDOR_ID, TRANSACAO_ID) 
VALUES ('2024-02-05', '2024-02-05 08:00:00', '2024-02-06 08:00:00', '2024-02-08 10:00:00', 'A', 'ACEITEI', 1, 2)

-------------------------------------------------------------------------------------CONSULTAS/ RELATORIOS--------------------------------------------------
/* QUANTIDADE DE CONTRATOS ENTRE 01.02.2024 A 01.03.2024 */
SELECT 
COUNT(CONTRATO.ID) AS QUANTIDADE
FROM contrato 
WHERE CONTRATO.DT_CONTRATO BETWEEN '2024-02-01' AND '2024-03-01'


/* QUANTIDADE DE CONTRATOS ENTRE NO ANO DE 2024 */
SELECT 
COUNT(CONTRATO.ID) AS QUANTIDADE
FROM contrato 
WHERE YEAR(CONTRATO.DT_CONTRATO) = 2024 


/* VALOR POR VEICULO */
SELECT 
CONTRATO.ID AS CONTRATO_ID,
transacao.VALOR_PAGO AS VALOR,
veiculos.MODELO,
CASE
WHEN plano_pgt.FORMA_PGT = 'B' THEN 'BOLETO' 
END 
AS FORMA_PAGAMENTO

FROM CONTRATO 
INNER JOIN TRANSACAO ON
CONTRATO.TRANSACAO_ID = transacao.ID

INNER JOIN plano_pgt ON
transacao.PLANO_PGT_ID = plano_pgt.ID

INNER JOIN contrato_veiculos ON
CONTRATO.ID = contrato_veiculos.CONTRATO_ID

INNER JOIN veiculos ON
contrato_veiculos.VEICULOS_ID = veiculos.ID

